# Identification Provider Manager Service

This service is responsible to create the keycloak users upon a domain user event.

## Architecture Overview

![alt text](./img/idp-manager-service-overview.png "Architecture Overview")

### Decisions

- Whenever a user domain event is received a keycloak user is created.
- The email is unique per user and it's used as **username**
- A default password is created for a user and it is **"password"**
- When a user is created on the keycloak the message is ignored.
- When a user has the role **DOCTOR** on the keycloak the user has the role **ROLE_DOCTOR**.
- When a user has the role **PATIENT** on the keycloak the user has the role **ROLE_USER**.

### User Event Consumer Configuration

- Configuration class that defines the consumer function.
- Consumer is a functional interface to assignment target, on our case the consumer is the UserEvent.
- When defining the property, **spring.cloud.function.definition** with the consumer, this will create an integration
  channel and that channel will be bind to a kafka topic.
- This consumer is responsible to receive user events from user.events topic and to create the keycloak user.

### Keycloak Service Factory
- Factory class that returns the correct keycloak service implementation depending on the user event type.
- **USER_CREATED** Event -> means that a user has to be created.
- [NOT IMPLEMENTED] - **USER_UPDATED** -> means that the user changed his information and should be updated.
- [NOT IMPLEMENTED] - **USER_DELETED** -> means that the used was deleted, and it should be deleted from keycloak.

### Logging
In order to have log visibility an aspect, LoggingAspect.class, was created.

### Configurable Properties

```xml
keycloak:
  serverUrl: http://localhost:9080/auth
  realm: medical-appointment
  clientId: internal
  clientSecret: internal
  username: admin
  password: admin
```
**Remark**
- username -> this user requires the following roles:
- manage-users role
- view-realm role


## Setting up the Environment

To run this project you will need.

Docker installed.

## Running Tests

To run tests, run the following command

```bash
 ./mvnw test
```

## Build the application

To build the application, run the following command

```bash
./mvnw package 
```

- mvnw.sh is available on the root of the project.
- This command will create a executable jar and it will generate a docker image.
- The docker image will be generated by running the Jib command **dockerBuild** which is include on the maven phase package.
- The docker image name will be **idp-manager-service**

## Tech Stack

- Java 11
- Spring Framework 5
- Spring Boot 2.5.4
- Kafka 6.1
- Testcontainers
